webpackJsonp([0xd9e662ebc530],{367:function(A,e){A.exports={data:{site:{siteMetadata:{title:"AllenDK",author:"Allen DK"}},post:{id:"/Users/temp/Desktop/gatsby/src/posts/use-p2-in-egret/index.md absPath of file >>> MarkdownRemark",html:'<h1>Use p2.js in Egret Game</h1>\n<h2>Summary</h2>\n<p><a href="https://github.com/schteppe/p2.js">p2.js</a> 是Egret官方推荐的物理引擎，相对\nbox2d引擎更轻量并且效率也更高，适合于H5游戏开发的使用。（个人原因是不喜欢box2d，莫名的）\n开发的游戏是"物理弹球"的小游戏，因为之前并没有在Egret上使用物理引擎，所以算是试了趟水，\n踩了一些坑吧，毕竟p2的国内文档并不是很多，但是其实看官方<a href="http://schteppe.github.io/p2.js/docs/">API和文档</a>\n就已经足够了，加之Egret本身也有关于p2的使用<a href="https://github.com/egret-labs/egret-game-library/tree/master/physics">Demo</a>，\n所以使用起来还算顺利，就简单记录下心得吧。</p>\n<h2>创建世界</h2>\n<p>使用物理引擎当然需要物理世界啦，所以第一步就是先创建一个合适的物理世界。</p>\n<pre><code class="language-TypeScript">    public createWorld() {\n        let wrd: p2.World = new p2.World();\n        this.world = wrd;\n\n        wrd.sleepMode = p2.World.BODY_SLEEPING;\n        wrd.gravity = [0, 2000];\n        wrd.applyGravity = false;\n        this.world.setGlobalStiffness(1e20);\n        this.world.defaultContactMaterial.restitution = .1;\n\n        this.world.addContactMaterial(new p2.ContactMaterial(NodeHelper.Material_Ball, NodeHelper.Material_Ball, {\n            restitution: 0,\n            friction: 1\n        }));\n        ...\n    }\n</code></pre>\n<p>首先，创建了一个世界，然后设置世界内物体的睡眠模式，之后设置了重力，这里值得注意的是，\n在p2引擎里，向量和坐标所使用的都是数组，即<code>[x, y]</code>模式。在之后，设置了是否自动使用重力，\n这里设置为<code>false</code>，因为在本游戏中需要自行进行重力加速的的累加计算，而不是由引擎自己进行。\n这种设置其实在物理游戏内很常见，因为总有各种特殊的需求，当由自己控制的时候会方便很多。\n再然后，就是设置一些属性了，比如设置了全局的物体硬度，这只适用于默认材质的物体，自然是\n数值越大就硬度越高了。之后设置了默认碰撞材质的弹性力度，值从0到1，越大弹性越好，1的时候\n就是以相同速度反弹回去了。之后添加了一些游戏中用到的碰撞材质，同时设置了弹性和摩擦属性，\n在物理游戏中这些属性很重要，非常影响游戏体验，所以必须得要反复调试，适应需求来调整，这里\n就不赘述了。</p>\n<h2>设置调试显示</h2>\n<p>首先，p2本身是没有支持显示功能的，也就是说，你创建出来的任何物体和形状都是看不到的，只有\n引擎自身在进行计算，虽然如此，p2的<code>body</code>也有个一个<code>.displays</code>属性，它是一个数组，可以\n用来存储所有你想与这个<code>body</code>绑定的显示对象，然后在进行显示位置的轮询更新，这样就达到了\n显示的目的，虽说有点麻烦，但是还是很灵活的。\n这里我就不贴代码了，每个游戏的需求是不同的，但是有个用于显示Debug调试的工具可以在项目前期\n使用，<a href="https://github.com/egret-labs/egret-game-library/blob/master/physics/demo2/src/p2DebugDraw.ts">p2DebugDraw</a>\n使用方法如下：</p>\n<pre><code class="language-TypeScript">    private createDebug(): void {\n        if(this.debugDraw) return;\n        //创建调试试图\n        this.debugDraw = new p2DebugDraw(world);\n        let sprite: egret.Sprite = new egret.Sprite();\n        this.addChild(sprite);\n        this.debugDraw.setSprite(sprite);\n    }\n</code></pre>\n<h2>创建物体</h2>\n<p>首先创建<code>body</code>即刚体</p>\n<pre><code class="language-TypeScript">    public createBody(x:number, y:number, mass:number, angle:number = 0):p2.Body {\n        let body = new p2.Body({\n            mass,\n            position:[x, y],\n            type:p2.Body.DYNAMIC,\n            angle,\n            gravityScale: 1,\n        });\n        return body;\n    }\n</code></pre>\n<p>参数就不多解释了，API都有，主要说几个问题吧。<code>type</code>有<code>DYNAMIC</code>和<code>STATIC</code>之分，如字面\n意思。<code>angle</code>是弧度不是角度。<code>gravityScale</code>设置为0则无视重力，1为满重力，-1为反重力。\n还有，如果在构造之后对<code>mass</code>进行赋值或者更改的话，需要再调用<code>updateMassProperties()</code>\n才能生效。\n然后创建形状</p>\n<pre><code class="language-TypeScript">    createBox(width:number, height:number, angle:number, group:number, mask:number):p2.Box {\n        let shape = new p2.Box({\n            width,\n            height,\n            angle,\n            collisionGroup: group,\n            collisionMask: mask,\n        });\n        shape.material = NodeHelper.Material_Target;\n        return shape;\n    }\n</code></pre>\n<p><code>width</code>，<code>height</code>，<code>angle</code>是基本属性，没什么可说的，<code>collisionGroup</code>是该物体所属的\n碰撞检测组，<code>collisionMask</code>是该物体期望碰到的物体组进行 <code>|</code> 运算之后的数值，例如</p>\n<pre><code>    shape.collisionGroup = CollisionGroup.Target;\n    shape.collisionMask = CollisionGroup.Ball | CollisionGroup.GameOver;\n</code></pre>\n<p>所以碰撞组的值应该是<code>pow(2, x)</code>。\n<code>material</code>是物体的材质，材质这个类只有一个属性，即<code>id</code>用来区分，在世界添加碰撞材质的时候\n<code>addContactMaterial(mat1:p2.Material, mat2:p2.Material)</code>用的到。\n之后要进行添加</p>\n<pre><code>    body.addShape(shape);\n    world.addBody(body);\n</code></pre>\n<p>这样，就在世界中添加了一个物体了。</p>\n<h2>动起来</h2>\n<p>加了之后要怎么样驱动呢？进行轮询。</p>\n<pre><code>    world.step(0.016);\n</code></pre>\n<p>轮询的参数应该是固定值，而且轮询的间隔也应该是固定的，即<code>fixed</code>。</p>\n<h2></h2>\n<blockquote>\n<p>好了，至此基本流程就走完了。说一下项目过程中遇到的一些问题吧</p>\n<ul>\n<li>会出现物理引擎的常见问题，就是重叠的问题，两个物体相碰撞的时候会在两帧之间与另一个物体\n相交，这在很多时候都是不愿意看到的，所以在不修改引擎的基础上，就要进行射线检测了，这就留作优化部分吧。</li>\n<li>物理游戏和别的游戏有很大差别，所有的参数设置都要经过细细推敲，不能靠感觉，当然，经验\n也就很重要了，所以，对不懂的事情多动动脑子，别老是想当然。</li>\n</ul>\n</blockquote>\n<p>最后，补上两张游戏成品截图。\n\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/balls_1-743a2f319673d217b5056bd08e7fe395-40dce.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 630px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 169.19315403422982%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAiABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAECBAMF/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAc1s/Syqgr1a5fOVVEESD//EABwQAQADAAIDAAAAAAAAAAAAAAECAxEABBAgIf/aAAgBAQABBQLBCEcfjwNODjK1l4pual7UvX//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAXEQEAAwAAAAAAAAAAAAAAAAARECBB/9oACAECAQE/AWNaf//EAB4QAAEEAQUAAAAAAAAAAAAAAAEAEBEhAiAiMTLx/9oACAEBAAY/ArzR38KjLRFtKM+MSADK642NP//EAB8QAQEAAQMFAQAAAAAAAAAAAAERACExURAgQWFx4f/aAAgBAQABPyEMRHyJik2LeYSEHOEjWce8gFW2vHRAG5riSlpPxlyCETXDkfsL2//aAAwDAQACAAMAAAAQ5/48eC//xAAWEQEBAQAAAAAAAAAAAAAAAAABESD/2gAIAQMBAT8QUCuv/8QAGhEBAAEFAAAAAAAAAAAAAAAAEQEQICExQf/aAAgBAgEBPxAQvKEaM2f/xAAdEAEAAgEFAQAAAAAAAAAAAAABABExECFBUWFx/9oACAEBAAE/EHyc3JSNsghG1HFGcx6LiBUvV0FisuopSZYoaYqu+YtKPEVwsBfkwc8swu/jQvrBb9viR0l3EB8eZegrlXT/2Q==\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="1"\n        title=""\n        src="/static/balls_1-743a2f319673d217b5056bd08e7fe395-082ce.png"\n        srcset="/static/balls_1-743a2f319673d217b5056bd08e7fe395-c7cb1.png 158w,\n/static/balls_1-743a2f319673d217b5056bd08e7fe395-93041.png 315w,\n/static/balls_1-743a2f319673d217b5056bd08e7fe395-082ce.png 630w,\n/static/balls_1-743a2f319673d217b5056bd08e7fe395-40dce.png 818w"\n        sizes="(max-width: 630px) 100vw, 630px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    \n\n  <a\n    class="gatsby-resp-image-link"\n    href="/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-e4f33.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 630px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 168.3698296836983%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAiABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAIDAQT/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB8sdzs1SJm8o0SrUAV//EABkQAAIDAQAAAAAAAAAAAAAAAAERABAhQf/aAAgBAQABBQIkTIYa4VXGI9bpV//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BX//EABoQAAICAwAAAAAAAAAAAAAAAAEQACEgMbH/2gAIAQEABj8CYtiEjSvmX//EAB8QAAICAQQDAAAAAAAAAAAAAAERACExEEFRcWGBsf/aAAgBAQABPyGpRJVz2PcQpCAOAlZ+xx0lSZAuKsBvHSBaIDaTkCvxiIm3QieYnA0//9oADAMBAAIAAwAAABBMPI0MH//EABYRAQEBAAAAAAAAAAAAAAAAAAEQIP/aAAgBAwEBPxCCrj//xAAWEQADAAAAAAAAAAAAAAAAAAAQICH/2gAIAQIBAT8QFT//xAAiEAEBAAICAQMFAAAAAAAAAAABEQAhMVFBcZGxEGGhwdH/2gAIAQEAAT8QRLA09zw/3BNh0cD8ZE4E6Dy9YqkSoUJDl1z9B7F+XGkTAFftqHpi2guFQd8aw9i/LixqVuzIVvdJg0GjZwrrEChpwkN5A0H1wF/VnHGf/9k=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="2"\n        title=""\n        src="/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-082ce.png"\n        srcset="/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-c7cb1.png 158w,\n/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-93041.png 315w,\n/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-082ce.png 630w,\n/static/balls_2-deb80110a0d32135561122d5e8cfd5b7-e4f33.png 822w"\n        sizes="(max-width: 630px) 100vw, 630px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>',frontmatter:{title:"Use p2.js in Egret",description:"Use p2.js(a physic engine) in Egret game project.",path:"/use-p2-in-egret/",date:"May 11, 2018"}}},pathContext:{path:"/use-p2-in-egret/"}}}});
//# sourceMappingURL=path---use-p-2-in-egret-d75b2798aed79347a107.js.map